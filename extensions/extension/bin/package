#!/usr/bin/env bash

[[ -n "$extensions" ]] || fail "A extension must be specified."

ensure_paths_exist "$archives_path/"

# bdsm extension package A,B,C
for extension in ${extensions//,/ } ; do

  if [[ -s "$extensions_path/$extension/VERSION" ]] ; then
    version="$(cat "$extensions_path/$extension/VERSION")"
  else
    fail "The version must be specified in $extensions_path/$extension/VERSION"
  fi

  release_name="${extension}-${version}"
  releases_path="${extensions_path}/${extension}/archives"
  release_path="${releases_path}/${release_name}"

  rsync -avgz --delete \
    --exclude ".git" --exclude ".svn" --exclude ".hg" --exclude "archives" \
    "${extensions_path}/${extension}/" "$release_path/"

  cd "${releases_path}"

  tar zcvf "${release_name}.tar.gz" "${release_name}/"

  rm -rf "$release_path/"

done

exit $result
