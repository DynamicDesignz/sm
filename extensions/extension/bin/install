#!/usr/bin/env bash

# bdsm extension install $extension --url=http://bdsm.beginrescueend.com/extensions/<name>-<version>.tar.gz install
# bdsm extension install $extension --url=git://github.com/...

extend_from_repository()
{
  (
  if [[ -d "$extension_src_path/.git" ]] ; then
    log "Updating $extension repository."
    enter "$extension_src_path"
    git fetch ${remote:-origin}

    # TODO: Branch switching logic

    git reset --hard HEAD
    git pull --rebase --force ${remote:-origin} "${branch:-master}"
  else
    log "Cloning $extension repository from $extension_repo_url."
    enter "$extension_src_path"

    # TODO: git/hg/svn url detection, only git to start for now

    git clone --depth 1 "${extension_repo_url}" "${extension}"
  fi
  )
  cp -Rf "${extension_src_path}/${extension_name}" "$bdsm_path/extensions/"

}

extend_from_tarball()
{
  curl -L "${releases_url}/${extension}-${extension_version}.tar.bz2" \
    -o "${extension_src_path}/${extension}-${extension_version}.tar.bz2"

  tar xf "${extension_src_path}/${extension_version}.tar.bz2" -C "${extension_src_path}/extensions"

  cp -Rf "${extension_src_path}/${extension_name}-${extension_version}" "$bdsm_path/extensions/"

}

[[ $# -gt 1 ]] || fail "At least one extension must be specified."

extension_src_path="${src_path}/extensions"
ensure_paths_exist "$extension_src_path"

case "${extension_version:-head}" in
  *([[:digit:]]).*([[:digit:]]).*([[:digit:]]))
    extend_from_tarball
    ;;

  head|master)
    extend_from_repository # default is head
    ;;
esac

