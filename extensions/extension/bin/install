#!/usr/bin/env bash

# bdsm extension install $extension --url=http://bdsm.beginrescueend.com/extensions/<name>-<version>.tar.gz install
# bdsm extension install $extension --url=git://github.com/...

extend_from_repository()
{
  (
  if [[ -d "$extensions_src_path/.git" ]] ; then
    log "Updating $extension repository."
    enter "$extensions_src_path"
    git fetch ${remote:-origin}

    # TODO: Branch switching logic

    git reset --hard HEAD
    git pull --rebase --force ${remote:-origin} "${branch:-master}"
  else
    log "Cloning $extension repository from ${extensions_repository_url}"

    enter "${src_path}"

    # TODO: git/hg/svn url detection, only git to start for now

    git clone --depth 1 "${extensions_repository_url}" "extensions"
  fi
  )
  enter "${extensions_src_path}/${extension}"

}

extend_from_tarball()
{
  curl \
    -L "${releases_url}/${extension}-${extension_version}.tar.bz2" \
    -o "${extensions_src_path}/${extension}-${extension_version}.tar.bz2"

  tar \
    xf "${extensions_src_path}/${extension_version}.tar.bz2" \
    -C "${extensions_src_path}/extensions"

  enter "${extensions_src_path}/${extension}-${extension_version}"
}

case "${extension_version:-head}" in
  *([[:digit:]]).*([[:digit:]]).*([[:digit:]]))
    extend_from_tarball
    ;;

  head|master)
    extend_from_repository # default is head
    ;;
esac

for _extension in "${extension_args}" ; do
  extension_src_path="${extensions_src_path}/${_extension}" \

  if [[ -s "${extension_src_path}/VERSION" && -x "${extension_src_path}/bin/help" ]] ; then
    cp -Rf \
      "${extension_src_path}" \
      "$bdsm_path/extensions/"
  else
    error "${extension_src_path}/${extension} is not a proper extension."
  fi
done

