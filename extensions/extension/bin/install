#!/usr/bin/env bash

[[ -n "$extensions" ]] || fail "At least onte extension must be specified."

ensure_paths_exist "$src_path/extensions/" "$archives_path/"

# bdsm extension --url=http://bdsm.beginrescueend.com/extensions/<name>-<version>.tar.gz install
# bdsm extension --url=git://github.com/... install

# bdsm extension package A,B,C

for extension in ${extensions//,/ } ; do

  if [[ ${head_flag:=0} -eq 1 ]] ; then

    if [[ ! -d "$src_path/$extension/.git" ]] ; then
      "$modules_path"/log "info" "Updating $extension repository."
      cd "$src_path/$extension"/.git
      # TODO: Branch update logic.
      git pull origin "${branch:-master}"
    else

      log "Cloning $extension repository from $extension_repo_url."
      cd "$src_path/$extension/"
      # TODO: git/hg/svn url detection, git for now
      git clone "$extension_repo_url"
    fi

  else
    rm -rf "$src_path/bdsm/latest"
    mkdir -p "$src_path/bdsm/latest"
    curl -O "$releases_url" | tar xf - -C "$src_path/bdsm/latest"
    # TODO: error check and exit on error.
    cd "$src_path/bdsm/latest"/bdsm-*
    ./install
  fi

done

exit $result
