#!/usr/bin/env bash

list_help()
{
  log "

Usage:

  bdsm extension list <action>

Actions:

  installed - List installed extensions
  available - List available extensions
  help      - Show this help text

"
}

list_installed()
{
  version_files=($(
    find "${extensions_path}"/* -mindepth 1 -maxdepth 1 -name 'VERSION' -type f
  ))

  if [[ ${#version_files[@]} -eq 0 ]] ; then
    log "No extensions currently installed."
  else
    for version_file in ${version_files[@]} ; do
      extension_source_path="${version_file/%\/VERSION}"
      extension_name="${extension_source_path//*\/}"

      case ${extension_name} in
        bdsm|[[=.=]]*)
          true # Ignore for now.
          ;;
        *)
          log "${extension_name//*\//}"
          ;;
      esac
    done
  fi
}

list_available()
{
  [[ -d "${extensions_src_path}" ]] || fetch_repository

  if [[ -d "${src_path}" ]] ; then
    version_files=($(
      find "${extensions_src_path}"/* -mindepth 1 -maxdepth 1 -name 'VERSION' -type f
    ))

    for version_file in ${version_files[@]} ; do
      extension_source_path="${version_file/%\/VERSION}"
      extension_name="${extension_source_path//*\/}"

      [[ -s "$version_file" ]] || continue

      case ${extension_name} in
        bdsm|extension|[[=.=]]*)
          true # Ignore for now.
          ;;
        *)
          printf "${extension_name//*\//}\n"
          ;;
      esac
    done
  else
    fail "No extensions found. Run 'bdsm extensions clone' to make them available. ( ${src_path} )\n"
  fi
}

extension_action=${extension_args[0]}

case "$extension_action" in
  installed)
    list_installed
  ;;

  available)
    list_available
  ;;

  help|usage)
    list_help
  ;;

  *)
    fail "$(list_help)"
  ;;
esac

exit 0
