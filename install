#!/usr/bin/env bash

# Load System Configuration, if it exists.
[[ -s "/etc/bdsmrc" ]] && . /etc/bdsmrc

# Load User Configuration, if it exists.
[[ -s "$HOME/.bdsmrc" ]] && . "$HOME/.bdsmrc"

# The default prefix is /usr/local,
# this should be set to where BDSM is installed to in /etc/bdsmrc
prefix="${prefix:-/usr/local}"

if [[ "$prefix" = "$HOME" ]] ; then
  true "${bdsm_path:="${prefix}bdsm"}"
else
  true "${bdsm_path:="${prefix}/bdsm"}"
fi

true "${modules_path:="${bdsm_path}/modules"}"

# Load BDSM bash DSL functions and initialize for BDSM core itself manually.
source "./modules/bash/bdsm/functions"
# filesystem DSL
for module in filesystem trace bdsm ; do
  for file in functions initialize  ; do
    source "./modules/bash/${module}/${file}"
  done
done

modules trace

while [[ $# -gt 0 ]] ; do
  token="$1" ; shift
  case "$token" in
    --trace)
      export trace_flag=1
      enable_trace
      ;;
  esac
done

ensure_paths_exist \
  "${bdsm_path}"

directories=(bin modules config extensions)

(
  enter "${bdsm_path}"
  ensure_paths_exist "${directories[@]}"
)

copy_directories_to "${bdsm_path}" \
  "${directories[@]}"

copy_files_to "${bdsm_path}" \
  LICENCE \
  VERSION \
  README

ensure_files_exist \
  "${config_path}/user" \
  "${config_path}/db"

remove_files \
  "${prefix}/bin/bdsm"

link "${bdsm_path}/bin/bdsm" to "${prefix}/bin/bdsm" --force

