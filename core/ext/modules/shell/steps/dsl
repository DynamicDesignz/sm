#!/bin/sh

start_step()
{
  steps_started+=( "$1" )
}

step()
{
  local name="$1"
  shift || fail "Cannot take step as no step name given;"\
    "step [name] <- missing name."

  start_step "$name"

  ! command_exists before_step || before_step "$name" "$@"

  "$name" "$@"

  ! command_exists after_step || after_step "$name" "$@"
}

steps()
{
  for step in $@
  do
    step "${step}"
  done
}

retreat()
{
  local step

  if array_is_empty steps_started
  then
    steps_started=( "$@" )
  fi

  while array_is_nonempty steps_started
  do
    array_pop steps_started step
    ! command_exists "fail_${step}" || "fail_${step}"
    ! command_exists after_step || after_step "fail_${step}"
  done
}
