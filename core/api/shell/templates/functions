#!/bin/sh

# TODO: Rework this into a 1.0.0 module API

#
#     user$ templates install "nginx.conf" \
#           to "${nginx_path}/nginx.conf" \
#           mode 0644 owner "${nginx_user}"
#
#    user$ templates seed "/etc/conf.d/${extension}.conf" \
#      prefix_path "${prefix_path}" \
#      init_scripts_path "${init_scripts_path}" \
#      modules_path "${modules_path}" \
#      data_path "${data_path}" \
#      confd_path "${confd_path}" \
#      extension "${extension}"
#
# Note that if you wish to eliminate all unset strings, pass the pair
#     ".*" ""
# as the last pair of arguments to templates seed.
#
templates()
{
  trace_filter templates

  local _command _name _target _source="${extension_templates_path}" \
    _mode=0644 _owner=$USER _template _params=()

  while (( $# > 0 ))
  do
    _token="${1}" && shift
    case "${_token}" in
      to)
        _target="$1"
        shift || fail "target path must follow keyword 'to'"
        ;;
      mode)
        _mode="$1"
        shift || fail "mode must follow keyword 'mode'"
        ;;
      owner)
        _owner="$1"
        shift || fail "owner must follow keyword 'owner'"
        ;;
      from)
        fail "'from' keyword is no longer supported"
        ;;
      *)
        if [[ -z "${_command}" ]]
        then
          _command="${_token}"
        elif [[ -z "${_name}" ]]
        then
          _name="${_token}"
#        elif [[ -z "${_target}" ]]
#        then
#          _target="${_token}"
        else
          _params+=("${token}")
        fi
        ;;
    esac
  done

  case "${_command}" in
    (exist|install|seed|update)
      __sm.templates.${_command} "${_name}" "${_params[@]}"
      ;;
    (*)
      fail "Unknown command '${_command}' for templates API."
      ;;
  esac
}

