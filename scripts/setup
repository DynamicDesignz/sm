#!/usr/bin/env bash

if [[ "root" = $(whoami) ]] ; then
  echo "Must be run as the project user."
  exit 1
fi

for dir in config log pids sockets "public/assets" tmp  ; do
  mkdir -p "$project_path/shared/$dir"
done

touch $project_path/shared/config/database.yml

touch $project_path/.bash_profile

if ! awk "/^project/" "$project_path/.bash_profile" ; then
  echo "project=\"$(user)\" ; export project" >> $project_path/.bdsmrc
fi

if ! awk "/^environment/" "$project_path/.bash_profile" ; then
  echo "environment=\"production\" ; export environment" >> $project_path/.bdsmrc
fi

if ! awk "/^RAILS_ENV/" "$project_path/.bash_profile" ; then
  echo "RAILS_ENV=\"\$environment\" ; export RAILS_ENV" >> $project_path/.bdsmrc
fi

if ! awk '/current\/\.rvmrc/' "$project_path/.bash_profile" ; then
  echo 'if [[ -d $project_path/current ]] && [[ -f $project_path/current/.rvmrc ]] ; then source $project_path/current/.rvmrc ; fi' >> $project_path/.bdsmrc
fi

if [[ ! -s "$project_path/.rvm/scripts/rvm" ]] ; then
  git clone git://github.com/wayneeseguin/rvm.git && cd rvm && ./install
fi

echo -e "$project: &defaults\n  adapter: postgresql\n  username: $project\n  password: '$project'\n  database: ${project}_${environment}\n  pool: 5\n  timeout: 5000" >> $project_path/shared/config/database.yml

