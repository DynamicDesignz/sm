#!/usr/bin/env bash

[[ -s "/etc/bdsmrc" ]]  && . "/etc/bdsmrc"
[[ -s "$HOME/.bdsmrc" ]] && . "$HOME/.bdsmrc"

prefix="${prefix:-/usr/local}"
bdsm_path="${bdsm_path:-"${prefix}/bdsm"}"
scripts_path="${scripts_path:-"${bdsm_path}/scripts"}"
extensions_path="${extensions_path:-"${bdsm_path}/extensions"}"
templates_path="${templates_path:-"${bdsm_path}/templates"}"
config_path="${config_path:-"${bdsm_path}/config"}"
src_path="${src_path:-"${bdsm_path}/src"}"
bin_path="${bin_path:-"${bdsm_path}/bin"}"
archives_path="${archives_path:-"${bdsm_path}/archives"}"
remote="${remote:-"origin"}"
branch="${branch:-"master"}"
framework="${framework:-"rails"}"
keep_releases="${keep_releases:-"4"}"
timestamp="$(date +%m.%d.%Y-%H:%M:%S)"
user="$(whoami)"
hooks_flag="1"

export prefix bdsm_path scripts_path extensions_path templates_path config_path src_path bin_path archives_path remote branch framework keep_releases timestamp user hooks_flag

# TODO: Move this code to a 'project' initializer:
if [[ "root" != "$(whoami)" ]] ; then
  if [[ -z "$project" ]] ; then
  # TODO: Improve this line vv
    if [ -d $HOME/shared/$user ] ; then
      export project=$user
    fi
  fi

  if [[ ! -z "$project" ]] ; then
    # TODO: RAILS_ENV should only be in rails scripts :-p
    export RAILS_ENV="${RAILS_ENV:-"production"}"
    export project_path="${project_path:-$HOME}"
    export shared_path="${shared_path:-$project_path/shared}"
    export previous_path="${previous_path:-$project_path/previous}"
    export current_path="${current_path:-$project_path/current}"
    export discarded_path="${discarded_path:-$project_path/discard}"
    export database_name="${database_name:-"${project}_${environment}"}"
    if [[ -d "$project_path/previous" ]] ; then
      export old_releases="$(cd $project_path/previous && ls -t | awk "NR > $keep_releases { print \$0 }")"
    fi
    export RAILS_ENV project_path shared_path previous_path current_path discarded_path database_name old_releases

    # TODO: Make this even more flexible. eg. check
    if [[ -z "$vcs" ]] ; then
      if [[ -d "$shared_path/$project/.git" ]] ; then
        vcs="git"
      elif [[ -d "$shared_path/$project/.svn" ]] ; then
        vcs="svn"
      elif [[ -d "$shared_path/$project/.hg" ]] ; then
        vcs="hg"
      else
        vcs="git" # default to awesome :)
      fi
    fi
    export vcs

    if [ -f ".${project}rc" ] ; then source ".${project}rc" ; fi
  fi
fi

result=0

trap 'rm -rf "/tmp/bdsm/$$" >/dev/null 2>&1' 0 1 2 3 15

