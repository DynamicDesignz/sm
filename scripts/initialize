#!/usr/bin/env bash

scripts_path="${scripts_path:-"${prefix}/bdsm/scripts"}"

result=0
user=$(whoami)
if [ -z "$project" ] ; then
# TODO: Improve this line vv
  if [ -d $HOME/shared/$user ] ; then
    project=$user
  else
    echo -e "\$project was not specified."
    exit 1
  fi
fi
remote=${remote:-"origin"}
branch=${branch:-"master"}
framework=${framework:-"rails"}
keep_releases=${keep_releases:-"4"}
timestamp="$(date +%m.%d.%Y-%H:%M:%S)"
project_path="${project_path:-$HOME}"
shared_path="${shared_path:-$project_path/shared}"
current_path="${current_path:-$project_path/current}"
current_path="${current_path:-$project_path/current}"
RAILS_ENV="${RAILS_ENV:-"production"}" ; export RAILS_ENV
if [[ -d "$project_path/previous" ]] ; then
  old_releases="$(cd $project_path/previous && ls -t | awk "NR > $keep_releases { print \$0 }")"
fi

# TODO: Make this even more flexible. eg. check
if [[ -z "$vcs" ]] ; then
  if [[ -d "$shared/$project/.git" ]] ; then
    vcs="git"
  elif [[ -d "$shared/$project/.svn" ]] ; then
    vcs="svn"
  elif [[ -d "$shared/$project/.hg" ]] ; then
    vcs=hg
  else
    vcs="git" # default to awesome :)
  fi
fi

if [ -f ".${project}rc" ] ; then source ".${project}rc" ; fi

trap 'rm -rf "/tmp/bdsm/$$" >/dev/null 2>&1' 0 1 2 3 15

export user project remote branch framework keep_releases timestamp project_path current_path shared_path RAILS_ENV old_releases scripts_path vcs

