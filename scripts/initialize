#!/usr/bin/env bash

[[ -s "/etc/bdsmrc" ]]  && . "/etc/bdsmrc"

[[ -s "$HOME/.bdsmrc" ]] && . "$HOME/.bdsmrc"

prefix="${prefix:-/usr/local}"

bindir="${bindir:-/usr/local/bin}"

if [[ "$prefix" = "$HOME" ]] ; then
  bdsm_path="${bdsm_path:-"${prefix}bdsm"}"
else
  bdsm_path="${bdsm_path:-"${prefix}/bdsm"}"
fi

scripts_path="${scripts_path:-"${bdsm_path}/scripts"}"
extensions_path="${extensions_path:-"${bdsm_path}/extensions"}"
templates_path="${templates_path:-"${bdsm_path}/templates"}"
config_path="${config_path:-"${bdsm_path}/config"}"
src_path="${src_path:-"${bdsm_path}/src"}"
bin_path="${bin_path:-"${bdsm_path}/bin"}"
archives_path="${archives_path:-"${bdsm_path}/archives"}"
remote="${remote:-"origin"}"
branch="${branch:-"master"}"
framework="${framework:-"rails"}"
timestamp="$(date +%m.%d.%Y-%H:%M:%S)"
user="$(whoami)"
keep_releases=${keep_releases:-4}
hooks_flag="${hooks_flag:-1}"

# TODO: Move this code to a 'project' initializer:
if [[ "root" != "$(whoami)" ]] ; then

  if [[ -z "$project" ]] ; then

    # TODO: Improve this line vv
    if [[ -d "$HOME/shared/$user" ]] ; then
      export project="$user"
    fi

  fi

  project_path="${project_path:-$HOME}"
  shared_path="${shared_path:-$project_path/shared}"
  previous_path="${previous_path:-$project_path/previous}"
  current_path="${current_path:-$project_path/current}"
  discarded_path="${discarded_path:-$project_path/discard}"

  if [[ -d "$project_path/previous" ]] ; then

    old_releases="$(
    find "$project_path/previous/" -mindepth 1 -maxdepth 1 -type d |
    sort -r | awk "NR > ${keep_releases:-3} { print \$0 }"
    )"

  fi

  if [[ -n "$project" ]] ; then

    database_name="${database_name:-"${project}_${environment}"}"

    # TODO: Make this even more flexible. eg. check

    if [[ -z "$vcs" ]] ; then

      if [[ -d "$shared_path/$project/.git" ]] ; then

        vcs="git"

      elif [[ -d "$shared_path/$project/.svn" ]] ; then

        vcs="svn"

      elif [[ -d "$shared_path/$project/.hg" ]] ; then

        vcs="hg"

      else

        vcs="git" # default to awesome :)

      fi

    fi

    export database_name old_releases vcs

    [[ -s ".${project}rc" ]] && . ".${project}rc"
  fi
fi

export prefix timestamp user framework remote branch keep_releases $(env | awk -F= -v ORS=' ' '/_path$/{print $1}') $(env | awk -F= -v ORS=' ' '/_flag$/{print $1}')

result=0

trap 'rm -rf "/tmp/bdsm/$$" >/dev/null 2>&1' 0 1 2 3 15

