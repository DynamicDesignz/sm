#!/usr/bin/env bash

fetch_src()
{
  curl -L "${1}" -o "${1##*\/}"
}

extract_src()
{
  case "$1" in
    *.tar.gz|*.tgz)
      tar zxf "${1}"
      ;;
    *.tar.bz2)
      tar jxf "${1}"
      ;;
    *.zip)
      unzip "${1}"
      ;;
    *)
      fail "Unknown archive format for ${1}"
      ;;
  esac
}

configure_src()
{
  if [[ ${#configure_flags[@]} -gt 0 ]] ; then
    ./configure ${configure_flags[@]}
  else
    ./configure
  fi
}

make_src()
{
  # TODO: make this robust
  make
}

install_src()
{
  # TODO: make this robust
  make install
}

build_src()
{
  # Ensure that default values are set.
  true \
    "${source_path:=/usr/local/src}" \
    "${archive_format:=tar.gz}"

  package_file="${package}-${package_version}.${archive_format}"

  ensure_paths_exist "$source_path"

  enter "$source_path"

  fetch_src "${package_url}"

  extract_src "${package_file}"

  enter "${package}-${package_version}"

  configure_src

  make_src

  install_src
}

