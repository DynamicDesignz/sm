#!/usr/bin/env bash

# Author: Wayne E. Seguin
# See BDSM LICENSE file for Apache 2.0 license information.

# Load System then User Configuration, if exists.
. /etc/profile ; unset prefix_path
paths=(prefix_path $(env | awk -F= '/_path=/{print $1}' | sort))
# TODO: unset all _path variables.
unset "${paths[@]}"

for file in /etc/profile /etc/bdsmrc "$HOME/.bdsmrc" ; do
  [[ -s "${file}" ]]  && . "${file}"
done

# In case bdsm is being called from within a hook for example, we unset these:
unset extension action

# The default prefix is /usr/local,
# this should be set to where BDSM is installed to in /etc/bdsmrc
prefix_path="${prefix_path:-/usr/local}"

[[ "$prefix_path" = "$HOME" ]] \
  && { : "${bdsm_path:="${prefix_path}bdsm"}"; } \
  || { : "${bdsm_path:="${prefix_path}/bdsm"}"; }

export modules_path="${bdsm_path}/modules"
export initial_pwd="$PWD" # record this early on.

# Load BDSM bash DSL and initialize for BDSM core itself manually.
# Ensure that backtrace and logging are defined first as everything depends on them.
for script in dsl initialize ; do
  for module in core ; do
    source "${modules_path}/bash/${module}/${script}"
  done
done
unset script module

# Now process CLI arguments.
source "${modules_path}/bash/core/cli"

[[ -n "${error_message}" ]] && error "$error_message"

#
# Main Logic
#
if [[ -z ${extension} ]]
then
  extension_action "core" "help"
  exit 1
fi

if [[ -z ${action} ]]
then
  modules extensions
  log "Usage: \n  bdsm ${extension} [action]\nActions:"
  log "  $(extension_actions "${extension}")"
  exit 0
fi

disable_backtrace
extension_action "${extension}" "${action}"

