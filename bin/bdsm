#!/usr/bin/env bash

# Author: Wayne E. Seguin
# See BDSM LICENSE file for Apache 2.0 license information.

# Load System then User Configuration, if exists.
[[ -s "/etc/bdsmrc" ]] && . /etc/bdsmrc
[[ -s "$HOME/.bdsmrc" ]] && . "$HOME/.bdsmrc"

# In case bdsm is being called from within a hook for example, we unset these:
unset extension action

# The default prefix is /usr/local,
# this should be set to where BDSM is installed to in /etc/bdsmrc
prefix="${prefix:-/usr/local}"

if [[ "$prefix" = "$HOME" ]] ; then
  true "${bdsm_path:="${prefix}bdsm"}"
else
  true "${bdsm_path:="${prefix}/bdsm"}"
fi

true "${modules_path:="${bdsm_path}/modules"}"

export initial_pwd="$PWD" # record this early on.

# Load BDSM bash DSL and initialize for BDSM core itself manually.
source "${modules_path}/bash/core/dsl"
source "${modules_path}/bash/logging/dsl"

# Now initialize & process CLI arguments.
source "${modules_path}/bash/core/initialize"
source "${modules_path}/bash/core/cli"

[[ -n "$error_message" ]] && fail "$error_message"

#
# Main Logic
#
if [[ -n ${extension} ]] ; then
  if [[ "${action}" = "version" ]] ; then
    version
  elif [[ -n "${action}" ]] ; then
    extension_action "${extension}" "${action}"
  else
    log "Usage: \n  bdsm ${extension} [action]\nActions:\n  $(actions_for_extension "${extension}")"
  fi
else
  usage
fi
result=$?

if [[ ${verbose_flag:-0} -eq 1 ]]; then
  if [[ ${result} -gt 0 ]] ; then
    log "'$action $*' returned error ($result)\n\n"
  else
    log "'$action $*' returned success ($result)\n\n"
  fi
fi

exit $result
