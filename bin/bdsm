#!/usr/bin/env bash

# Author: Wayne E. Seguin
# All Rights Reserved

#
# Setup
#
# If the user is requesting a trace, turn shell internal trace mode on.
if echo "$*" | grep -q 'trace' ; then echo "$*" ; set -x ; fi

# The default prefix is /usr/local,
# this should be set to where BDSM is installed to in /etc/bdsmrc
prefix="${prefix:-/usr/local}"

# Load System Configuration, if it exists.
if [[ -s "/etc/bdsmrc" ]] ; then source "/etc/bdsmrc" ; fi

# Load User Configuration, if it exists.
if [[ -s "$HOME/.bdsmrc" ]] ; then source "$HOME/.bdsmrc" ; fi


# Initialize BDSM framework and variables.
source "${scripts_path:-"$prefix/bdsm/scripts"}"/initialize

# Load BDSM framework functions.
source "${scripts_path}"/functions

# Load the BDSM framework version.
VERSION="$(cat "$bdsm_path"/VERSION)"

_version() {
  _author="Wayne E. Seguin"
  _author_email="wayneeseguin@gmail.com"
  _website="http://bdsm.beginrescueend.com/"
  _version="$VERSION"
  echo -e "bdsm ${_version} ${_website} by ${_author} (${_author_email})"
}

usage() {
  _version
  "$extensions_path"/bdsm/bin/help | ${PAGER:-less}
}

#
# parse args
#
while [ $# -gt 0 ] ; do
  token="$1" ; shift
  case "$token" in
    # TODO: extension detection "did you mean"

    # TODO: Fall back on default actions instead of specifying them here
    #       In case the user has set their default serfice in the environment.

    deploy|rollback)
      extension="deploy"
      action="$token"
      parse_break=1
    ;;

    extend|extension)  extension="extension"           ;;
    --no-hooks)        hooks_flag=0                    ;;
    --project)         project="$1"            ; shift ;;
    --environment)     environment="$1"        ; shift ;;
    --repo|repository) repository="$1"         ; shift ;;
    --revision)        revision="$1"           ; shift ;;
    --database)        database="$1"           ; shift ;;
    --server)          server="$1"             ; shift ;; # better name for this?
    --head)            head_flag=1                     ;;
    --debug)           debug_flag=1                    ;;
    --trace)           trace_flag=1 ; export debug_flag=1 ; set -x ;;
    -v|--version)      action="version" ;;

    *)
      #if $scripts_path/match "$token" $extensions ; then
      if [[ -z "$extension" ]] ; then
        if [[ -d "$extensions_path/$token" ]] ; then
          export extension="$token"
        else
          export extension="${extension:-bdsm}"
        fi
      fi
      if [[ -z "$action" ]] ; then
        if [[ -x "$extensions_path/$extension/bin/$token" ]] ; then
          export action="$token"
          parse_break=1
        fi
      elif [[ -d "/data/$token" ]] ; then
        project="$token"
        project_path="/data/$token"
      elif [[ -d "/home/$token" ]] ; then
        project="$token"
        project_path="/home/$token"
      else
        # determine sanity of project
        action="error"
        error_message="Unrecognized command line argument(s): '$token $@'"
      fi
    ;;
  esac

  if [[ ! -z "$parse_break" ]] || [[ ! -z "$error_message" ]] ; then unset parse_break ; break; fi
done

if [[ ! -z "$error_message" ]] ; then exit 1 ; fi

#
# Main Logic
#
if [[ "$trace_flag" = 1 ]] ; then set -x ; else set +x ; fi

if [[ "version" = "$action" ]] ; then
  version
elif [[ ! -z "$extension" ]] && [[ ! -z "$action" ]] ; then
  if [[ -s "$extensions_path/$extension/bin/$action" ]] ; then
    extension_path="$extensions_path/$extension"
    extension_config_path="$extensions_path/$extension/config"
    extension_templates_path="$extensions_path/$extension/templates"
    extension_scripts_path="$extensions_path/$extension/scripts"
    extension_bin_path="$extensions_path/$extension/bin"
    export extension_path extension_config_path extension_templates_path extension_scripts_path extension_bin_path
    export hooks_flag project environment repository revision database server head_flag debug_flag trace_flag action extension tag branch

    pushd "$extensions_path/$extension" > /dev/null 2>&1
    #
    # TODO: allow output control.
    #
    #if [[ -z "$verbose_flag" ]] ; then
      "$extensions_path/$extension/bin/$action" $*
    #else
    # "$extensions_path/$extension/bin/$action" $* >2
    #fi
    result=$?
    if [[ "$result" -gt 0 ]] ; then
      : # log error
    else
      : # log success
    fi

    popd > /dev/null 2>&1
    unset extensions_path extension_config_path extension_templates_path extension_scripts_path
  fi
elif [[ ! -z "$extension" ]] ; then
  echo $(actions_for_extension $extension)
else
  usage
fi
result=$?

exit $result
